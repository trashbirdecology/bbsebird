---
title: "JAGS Models"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls()) # for use in dev
knitr::opts_chunk$set(echo = FALSE, 
                      message=FALSE, 
                      warning=FALSE,
                      fig.show = TRUE,
                      tidy = TRUE)
library(dubcorms)
library(dplyr)
library(ggplot2)
library(rjags)
library(stringr)
```
# Step 0: Setup
The parameter `dir.proj` __must__ be specified in the YAML header. 

```{r set-directories, echo=FALSE}
### i;d like to be able to figure out how to evaluate R code from the YAML header but thats for another time. see this SO issue:https://stackoverflow.com/questions/45646135/evaluating-r-code-in-yaml-header
dir.proj <- paste0(getwd(),"/")
dir.jags <- paste0(dir.proj, "jags/")
dir.plots <- paste0(dir.proj, "plots/")
dir.models <- paste0(dir.jags, "models/")
sapply(c(dir.plots, dir.models), FUN=
         function(x) dir.create(x, showWarnings = FALSE))
fns <- list.files(dir.jags, full.names = TRUE)
```
# Step 1: Original Data
## Import data
If data already exists, we can just import it from file. Otherwise, you will need to run through "1-Data_Munging.Rmd", which will take a hot minute.
```{r import-jdat, echo=TRUE}
jdat <- readRDS(fns[stringr::str_detect(fns, "jdat.rds")])
cat("jdat is of class ", toupper(class(jdat)) , " and contains the following ", length(jdat), " lists:")
names(jdat)
```

## Munging
Since we don't have route locations over time, let's just create

## Exploreperiod available data
If necessary, go ahead and explore the data. 
```{r data-metadata-tables}
### placeholder for creating some tables describing the data. 
jdat$bbs$C.route %>% head(2)
jdat$bbs$C %>% head(2)
jdat$grid$area # area (m^2) of the grid cell within confines of study area
jdat$grid$period # years of study
jdat$grid$T # number of years
```

# Step 2: Write JAGS Models
From here, you can specify JAGS models inside R by interactively creating text files, or you can point to the file in the JAGS model. 

## BBS-only 
```{r model-grid-bbs-pois}
mod <- "model{
# Priors
  beta0 ~ dunif(0,100)
  beta1 ~ dunif(0,100)

# Likelihood
  # y[r,t] = total count on route r at time t 
  # lambda[g,t] = expected count in a grid cell, g
  # lambda[r,t] = expected count on a route r

for(r in 1:R){
  for(t in 1:T){
  y[r,t] ~ dpois(lambda[r,t])

    for(g in 1:G){
      lambda[r,t] <- sum across w.prop[r,g] * lambda[g,t]
      log(lambda[g,t]) <-  log(w.area)

# Derived Parameters
  
  
    
      } # end G
    } # end T
  } # end R
  
}"

write.table(mod, file=paste0(dir.models, "bbs-grid-level-pois.txt"))
```

```{r export-model.jags}


```




# Step 3: Computational Specifications
## MCMC
```{r set-mcmc}
na <- 1000 # number of adaptation iterations
nb <- 5000 # number of iterations for burnin per chain
nc <- 3 # number of chains (min for now)
ncores <- detectCores() - 1 # number of cores to use; keep one free just in case, or not
ni <- 10000 # number of iterations per chain
nt <- 10 # thinning rate
```

## Initial values
```{r set-inits} 
inits <- function() list()
```

## Parameters monitored
```{r set-params} 
params <- c()
```


# Step 4: Computation (Run Model(s))
```{r}


```

