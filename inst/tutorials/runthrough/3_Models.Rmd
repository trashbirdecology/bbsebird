---
title: "JAGS Models"
output:
  pdf_document: default
params:
  fn.setup: "0_setup.rmd"
---
Use this script to create data for use in JAGS modelling activities. See page [45 of the JAGS manual](https://people.stat.sc.edu/hansont/stat740/jags_user_manual.pdf) for common JAGS functions. 

# Step 0: Setup 
 This chunk sources some redundant chunks in the data-munging r markdown
```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  message = TRUE, 
  echo=FALSE, 
  warning=FALSE, 
  tidy=TRUE, 
  include=FALSE
)
setup.chunk.needed<-FALSE
temp=tempfile(fileext=".R")
knitr::purl(params$fn.setup, output=temp)
source(temp)
# eval conditions/params

```

# Step 1: Data Data
## Import data
If data already exists, we can just import it from file. Otherwise, you will need to run through "1-Data_Munging.Rmd", which will take a hot minute.
```{r import-jdat, echo=TRUE}
jdat <- import_jdat(dir.jags)
```
## Browse data
Check out dimensions and contents of jdat object(imported with `import_jdat()`)
```{r metadata-jdat}
jdat.struc <- get_data_structure(jdat, dir.output=dir.jags)
# View(jdat.struc)
kableExtra::kable(jdat.struc)
```

## Specify JAGS data
To avoid warning messages from JAGS, just grab what you need. 
```{r make-jags.data}
jdat$prop.site.in.cell.bbs[is.na(jdat$prop.site.in.cell.bbs)] <- 0

jags.data <- list(
  cov1=cov1, 
  yBBS.site=jdat$yBBS.site, 
  T.bbs=jdat$T.bbs, 
  G.bbs=jdat$G.bbs, 
  S.bbs=jdat$S.bbs, 
  w=jdat$prop.site.in.cell.bbs
)
```

# Step 2: Computational Specifications
## MCMC
```{r set-mcmc}
na <- 1000 # number of adaptation iterations
nb <- 5000 # number of iterations for burnin per chain
# nc <- 3 # number of chains (min for now) (defined in call to JAGS as the length of inits list)
ncores <- parallel::detectCores() - 1 # number of cores to use; keep one free just in case, or not
ni <- 10000 # number of iterations per chain
nt <- 10 # thinning rate
```

## Set initial values
```{r set-inits} 
inits <- list(
  list(b1 = rnorm(1,0,1), alpha  = rnorm(1,0,1)),
  list(b1 = rnorm(1,0,1), alpha  = rnorm(1,0,1)),     
  list(b1 = rnorm(1,0,1), alpha  = rnorm(1,0,1))
  ) 
```

## Parameters monitored
```{r set-params} 
### must not name `params` b/c will conflict with YAML parameters
params.monitor <- c("lambda", "nu",  "b1", "N", "alpha")
```

# Step 3: Specify Model
```{r}
cov1 <- rnorm(jdat$G.bbs,0,1)
mod <- "model{
for(t in 1:T.bbs){
  for(s in 1:S.bbs){
    yBBS.site[s,t] ~ dpois(lambda[s])
  }} # end data model s and t
for(s in 1:S.bbs){
  lambda[s] = inprod(nu[], w[s,]) ## check inprod
} # end s (lambda route)

for(g in 1:G.bbs){
  log(nu[g]) <- cov1[g]*b1 + alpha 
} # end g (nu)

# Priors
b1    ~ dnorm(0,1)
alpha ~ dnorm(0,1)

# Derived
for(t in 1:T.bbs){
N[t] <- sum(yBBS.site[,t])
}

}"
## export model
# browseURL(mod.fn)
mod.name <- "bbs-pois-base" ## not sure why but when i knit the chunks outside this one it doesn't keep the params, so having trouble putting it up there.
mod.fn <- paste0(dir.models, mod.name, ".txt") # we want to name it now so we can call in jags functions
sink(mod.fn)
cat(mod)
sink()
```

# Step 4: Run JAGS
```{r make-jm}
# browseURL(mod.fn) ### open model file if you please
out <- jagsUI::jags(data  = jags.data,
                    model.file = mod.fn,
                    inits = inits,
                    parameters.to.save = params.monitor,
                    n.chains = length(inits), 
                    n.thin = nt, n.iter = ni, n.burnin = nb)
```

## Save outputs

# Step 5: Celebrate

