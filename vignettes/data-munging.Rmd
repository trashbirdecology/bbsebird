---
title: "runthrough"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{runthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  include=FALSE,
  warning=FALSE, 
  message=FALSE
)
```

```{r, eval=TRUE}
# 0:Setup -----------------------------------------------------------------
devtools::install_github("trashbirdecology/dubcorms",
                         force = FALSE, 
                         dependencies = TRUE)
#explicitly load some packages
pkgs <- c("dubcorms",
          "bbsAssistant",
          # "mapview",
          "reshape2",
          "stringr",
          "dplyr",
          "sf")
# install.packages("mapview")
invisible(lapply(pkgs, library, character.only = TRUE))
rm(pkgs)
```

# About Document {#about}
This document runs through the process of creating a list of relative and spatially-aligned eBird and BBS data for use in JAGS/elsewhere. The first Step, `Data Munging`

# Step 0: Setup {#setup}
Currently, this package does not include a single wrapper for creating the integrated data. This is mostly because the eBird data can be large, and any error in the wrapper that results in a re-run of the wrapper function may delay work. Therefore, this section comrpises three components: 
  1. create spatial sampling grid  
  1. create BBS and eBird data (aligned to spatial sampling grid)  
  1. bundle all data for use in JAGS (or elsewhere)  
  
We first set some arguments for use in functions below. This is here only for conveience. 
```{r set-args, eval=eval.ind}
args <-
  set_args(
    dir.orig.data  = "C:/Users/jburnett/OneDrive - DOI/research/cormorants/dubcorm-data-backup/",
    dir.proj  = "C:/Users/jburnett/documents/github/dubcorms-dev-scene/",
    states    = c("us-co", "us-ne", "us-wy", "us-SD"),
    countries           = c("US", "CA"),
    species    = c("house sparrow", "passer domesticus"),
    species.abbr    = c("houspa", "HOSP")
  )
```

# Step 1: Spatial Grid
```{r spatial-grid}
if(is.null(states)){ states.ind <- NULL}else{states.ind<-gsub(x=toupper(states), pattern="-", replacement="")}
grid <- make_spatial_grid(dir.out = args[['dir.spatial.out']],
                          overwrite=overwrite.grid,
                          states = states.ind,
                          countries = countries,
                          hexagonal=hexagonal,
                          crs.target=crs.target,
                          grid.size=grid.size
                          )
# plot(grid)
# mapview::mapview(grid)
```

# Step 2: BBS Data
```{r bbs-data}
## wrapper for creating all bbs dafa
# bbs <- make_bbs_data()
fns.bbs.in <-  list.files(args$dir.bbs.out, pattern = "bbs_obs.rds",recursive = TRUE, full.names = TRUE)
if(length(fns.bbs.in)>0 & !overwrite.bbs){bbs_obs <- readRDS(fns.bbs.in)}else{
  bbs_orig <- grab_bbs_data(overwrite = overwrite.bbs,
                            bbs_dir = args$dir.bbs.out)
  bbs_obs  <- munge_bbs_data(
    bbs_list = bbs_orig,
    states   = states,
    species = species,
    zero.fill = TRUE,
    observations.output = 'df',
    # do not change!
    year.range = year.range
  )
  bbs_obs <-
    dubcorms:::match_col_names(bbs_obs) # munge column names to mesh with eBird
  saveRDS(bbs_obs, paste0(args$dir.bbs.out, "/bbs_obs.rds"))
}# end bbs data munging

# Overlay BBS and study area/sampling grid
  bbs_spatial <- make_bbs_spatial(bbs_obs,
                          cws.routes.dir = args$cws.routes.dir,
                          usgs.routes.dir = args$usgs.routes.dir,
                          plot.dir = args$dir.plots,
                          crs.target = crs.target,
                          grid = grid,
                          dir.out = args$dir.spatial.out,
                          overwrite = overwrite.bbs
                          )
```
# Step 3: eBird
```{r ebird}
# fns.ebird.in <- list.files(args$dir.ebird.out,
#                             full.names = TRUE,
#                             recursive = TRUE)
(fns.ebird    <- id_ebird_files(
                        dir.ebird.in = args$dir.ebird.in,
                        dir.ebird.out = args$dir.ebird.out,
                        mmyyyy = mmyyyy,
                        species = species.abbr,
                        states.ind = states
))
stopifnot(length(fns.ebird)>1)

# Import and munge the desired files..
ebird <- munge_ebird_data(
  fns.ebird = fns.ebird,
  species = c(species, species.abbr),
  overwrite = overwrite.ebird,
  dir.ebird.out = args$dir.ebird.out,
  countries = countries,
  states = states,
  protocol = ebird.protocol,
  max.num.observers = max.num.observers,
  complete.only = complete.checklists.only,
  years = year.range
)

# Create spatial ebird
ebird_spatial <- make_ebird_spatial(df=ebird,
                   crs.target = crs.target,
                   grid=grid,
                   overwrite=overwrite.ebird,
                   dir.out=args$dir.spatial.out
                   )
```
## Step 4: Bundle data for Use in JAGS/Elsewhere
```{r jdat}
jdat <- make_jags_list(
  dat = list(ebird=ebird_spatial, 
               bbs=bbs_spatial, grid=grid, dirs=dirs),
  dir.out = args$dir.jags,
  overwrite = overwrite.jdat,
  max.C.ebird = max.C.ebird,
  scale.vars = TRUE,
  jagam.args = list(
    bs = "ds",
    k = 20,
    family = "poisson",
    sp.prior = "log.uniform",
    diagonalize = TRUE)
)
```

