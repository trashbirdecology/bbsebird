---
title: "Integrated Models"
params:
  # dir.proj: "C:/Users/aroyle/DOI/Burnett, Jessica L - cormorants/JAR/DCCO/"
  dir.orig.data: "C:/Users/jburnett/OneDrive - DOI/research/cormorants/dubcorm-data-backup/"
  dir.proj: "C:/Users/jburnett/documents/github/dubcorms/inst/tutorials/DCCO/"
  mmyyyy: "sep-2021" # month and year of most recent ebird EBD/samp download in file.
  species:  "DOCCOR,DOCCO,DCCO,DCCOR,Double-crested Cormorant,Double Crested Cormorant"
  states: "FL, Florida, GA, Georgia" # states/regions of interest
  year.range: 2008:2019 # for now, supply a range as integers (will fix later in `clean_params()`)
  grid.size: 1.00 #== 1 dec deg
---

```{r libraries, echo=TRUE}
# unloadNamespace("dubcorms") # just a precaution to ensure we get most recent dev version of pkg
unloadNamespace("dubcorms")
devtools::install_github("trashbirdecology/dubcorms", force=FALSE)

### specify packages that we call often 
pkgs <- c("dubcorms","bbsAssistant","rjags",
          "stringr","dplyr","mgcv")
invisible(lapply(pkgs, library, character.only = TRUE))
rm(pkgs)
```

```{r eval-params, eval=TRUE, include=FALSE}
# eval parameters
############## need to add into eval_params function some default values such that this can be run outside this rmd and also in case user forgets somethign minor. 
params.temp <- eval_params(params) # we cannot save as params--won't allow us to overwrite
# save params as objects in environment instead of inside a list (b.c of my laziness)
list2env(params.temp, envir = environment())
rm(params.temp) # remve temp 
```

```{r specs-dirs}
# proj.shorthand: this will make all directories within a new dir in dir.proj. this is useful for iterating over species/time/space and saving all resulting information in those directories.
subdir.proj <- proj.shorthand(species, states, grid.size, year.range)
dirs <- dir_spec(dir.orig.data, dir.proj, subdir.proj) # create series of directories for later use.
list2env(dirs, env=.GlobalEnv)# bind the dir values as named global objects (MUST INCLUDE `env=.GlobalEnv`)
rm(dirs)
```

Import pre-made data files for use in JAGS and mgcv
```{r retrieve-jags-data, eval=TRUE}
jags.data <- import_jdat(dir.jags)
gam.data  <- readRDS(list.files(dir.jags, "jagam", full.names=TRUE))
```


# Step 4: Specify GAMs
```{r rushing-gam}
ind <- names(gam.data)
jagam.mods <- rep(list(NA), length(ind))
names(jagam.mods) <- ind
for(i in seq_along(ind)){
mod.name <-  paste0("jagam_", ind[i])
mod.fn   <- paste0(dir.models, mod.name, ".txt")

# Specify GAMs
jagam.mods[[i]] <-
  mgcv::jagam(
    Cmax ~ s(
      x,
      y,
      k = 20,
      bs = 'ds',
      m = c(1, 0.5)
      ),
    data = gam.data[[i]],
    family = "poisson",
    file = mod.fn, 
    diagonalize = TRUE
  )
cat("JAGS model specification saved:\n", mod.fn, ".\n")
# ## Save JAGS data from model specification
# saveRDS(jagam.mods[[i]], file=paste0(dir.models, mod.name, ".rds"))


# Initial Values for Gams
inits$psi.se[abs(inits$psi.betas) > 8] <- 1
inits$psi.betas[abs(inits$psi.betas) > 8] <- 0
inits$p.betas[abs(inits$p.betas) > 8] <- 0
inits$th.betas[abs(inits$th.betas) > 8] <- 0








} #end gam loop


# 
# 
#  X = jagam.mod$jags.data$X,
#     S1 = jagam.mod$jags.data$S1,
#     zero = jagam.mod$jags.data$zero,
#     mu = inits$psi.betas,
#     se = inits$psi.se
# # Data for JAGS
# jags.data <-
#   list(
#     h = dat$h,
#     nStops = dat$nStops,
#     nRoutes = dat$nRoutes,
#     nYears = dat$nYears,
#     Xp = dat$wind,
#     nov = dat$nov,
#     obs = dat$obs,
#     nObs = max(dat$obs) - 1,
#     Xclim = covs,
#     nPred = dim(covs)[2] / 2,
#     twedt = dat$twedt,
#    
#   )
# ### Parameters to monitor
# jags.params <-
#   c(
#     "xpsi",
#     "pi",
#     "lambda",
#     "betaT",
#     "g",
#     "alpha0",
#     "alpha1",
#     "alpha2",
#     "alpha3",
#     "sigma.obs",
#     "sigma.gam",
#     "rho",
#     "b",
#     "omega",
#     "z"
#   )
```


```{r gam-ebird}
ebird.mod.name <- "ebird_jagam"
ebird.gam <- mgcv::jagam(
  y.ebird ~ s(t.ebird) + s(
    lon.ebird,
    lat.ebird,
    k = 20,
    bs = 'ds',#duchon spline
    m = c(1, 0.5)
  ),
  sp.prior = "log.uniform",#lambda penalty term
  diagonalize = TRUE,#reparameterize smoothed->iid gaussian
  data = gamdat$ebird %>% filter(grid %in% c(1:10) ),
  family = "poisson",
  file = paste0(dir.models, ebird.mod.name, ".txt"),
  na.action = na.omit
)
saveRDS(ebird.gam, file=paste0(dir.models, ebird.mod.name), ".rds")
```

# Step 5: Integrated Model
## Step 5a: Computational Specifications
### MCMC
```{r set-mcmc}
na <- 1000 # number of adaptation iterations
nb <- 5000 # number of iterations for burnin per chain
# nc <- 3 # number of chains (min for now) (defined in call to JAGS as the length of inits list)
ncores <- parallel::detectCores() - 1 # number of cores to use; keep one free just in case, or not
ni <- 10000 # number of iterations per chain
nt <- 10 # thinning rate
```

### Set initial values
```{r set-inits} 
inits <- list(
  list(b1 = rnorm(1,0,1), alpha  = rnorm(1,0,1)),
  list(b1 = rnorm(1,0,1), alpha  = rnorm(1,0,1)),     
  list(b1 = rnorm(1,0,1), alpha  = rnorm(1,0,1))
  )
```

### Parameters monitored
```{r set-params} 
### must not name `params` b/c will conflict with YAML parameters
params.monitor <- c("lambda", "nu",  "b1", "N", "alpha")
```

## Step 4b: Specify Model(s)
Get list of models saved in package. 
```{r}
bbs-pois <- system.file("inst/models/",
                     "bbs-pois",
                     mustWork = TRUE,
                     package="dubcorms")

```

## Step 4c: Run Model(s)
```{r run-jags}
# models in jags model dir
mod.fns   <- list.files(dir.models, full.names = FALSE, pattern=".txt|.jags") # names of models
mod.names <- sub(".txt|.jags", "", x=mod.fns) # remove the .rds files
mod.fns   <- paste0(dir.models, mod.fns) # tack on the directory 

# Choose the model to run
mod.fn   <- mod.fns[2]
mod.name <- mod.names[2]

jdat$area <- as.vector(scale(jdat$area, center=TRUE))
# names(jdat)
tictoc::tic()
out <- jagsUI::jags(data  = jdat,
                    model.file = mod.fn,
                    inits = inits,
                    parameters.to.save = params.monitor,
                    n.chains = length(inits), 
                    n.thin = nt, n.iter = ni, n.burnin = nb)
x=tictoc::toc()
mod.time <- paste0(round(x$toc-x$tic, 2), " seconds")
out$tictoc.allchains <- mod.time
# save model outputs
saveRDS(out, file=paste0(mod.name, ".rds"))
```


