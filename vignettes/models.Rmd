---
title: "Models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Step 0: Setup
```{r setup}
library(dubcorms)
library(rjags)
library(tidyverse)
## these should be the same args used in data-munging.RMD if you are to properly 
args <-
  set_args(
    dir.orig.data  = "C:/Users/jburnett/OneDrive - DOI/research/cormorants/dubcorm-data-backup/",
    dir.proj  = "C:/Users/jburnett/documents/github/dubcorms-dev-scene/",
    states    = c("us-co", "us-ne", "us-wy", "us-SD"),
    countries           = c("US", "CA"),
    species    = c("house sparrow", "passer domesticus"),
    species.abbr    = c("houspa", "HOSP")
  )
## commit the args to global environment so we don't have to index them
list2env(args, globalenv())
```

# Step 1: JAGS Data
Import the JAGS data list file as created in data-munging.rmd
```{r read-jdat}
jdat <- readRDS(list.files(dir.jags, pattern="jdat.rds", full.names = TRUE))
```

Although all data is stored in jdat, it may be easier to go ahead and a) grab only necessary data for your model and b) remove the nesting from the jdat list. 
```{r make-jags.data}
jags.data <-list(
  ## OBSERVED COUNTS
  C.b = jdat$bbs$C, 
  C.e = jdat$ebird$C,
  ## DETECTION COVARIATES
  p.b.fyr = jdat$bbs$Xp$fyrroute,
  p.b.w   = jdat$bbs$Xp$wind,
  ## GRID-LEVEL COVARIATES
  ### bbs data
  prop.b  = jdat$bbs$Xg$prop,
  area.b  = jdat$bbs$Xg$area,
  XY.b    = jdat$bbs$Xg$XY,
  ### ebird data
  area.e  = jdat$ebird$Xg$area,
  XY.e    = jdat$ebird$Xg$XY,
  ### grid data
  area.g  = jdat$grid$area,
  XY.g    = jdat$grid$XY, 
  ## INDEXING
  ###### Note: for now, silencing out the "id"s beacuse we won't use in jags
  ### bbs
  S.b     = jdat$bbs$indexing$nsites, 
  S.ind.b = jdat$bbs$indexing$sites.ind, 
  # S.id.b  = jdat$bbs$indexing$sites.id, 
  T.b     = jdat$bbs$indexing$nyears, 
  T.ind.b = jdat$bbs$indexing$year.ind, 
  # T.id.b  = jdat$bbs$indexing$year.id, 
  G.b     = jdat$bbs$indexing$ngrids, 
  ### ebird
  S.e     = jdat$ebird$indexing$nsites, 
  S.ind.e = jdat$ebird$indexing$sites.ind, 
  # S.id.e  = jdat$ebird$indexing$sites.id, 
  T.e     = jdat$ebird$indexing$nyears, 
  T.ind.e = jdat$ebird$indexing$year.ind, 
  # T.id.e  = jdat$ebird$indexing$year.id, 
  G.e     = jdat$ebird$indexing$ngrids,  ### grid/entire study period
  T       = sort(unique(c(jdat$bbs$indexing$year.id, jdat$ebird$indexing$year.id))), 
  G       = nrow(jdat$grid$XY),
  area    = jdat$grid$area 
)

jagam.data <- jdat$gam
```


# Step 2: Model and MCMC Specs
This section allows user to create a JAGS model file within R, and saves to relevant JAGS directory. 
## Step 1a: Specify model
```{r bbs-mod}
## just packaged it up to run in be able to collapse and run in one "line"
mod <- function(){ "model{
####################################################
####################################################
# Likelihoods
####################################################
for(t in )
for(t in 1:T.b){
  for(s in 1:S.b){
    C.b[s,t] ~ dpois(lambda[s])
  } # end bbs data model s
} # end bbs data model t
  
for(s in 1:S.b){
  lambda[s]  = inprod(nu[], prop.b[s,])
} # end s (lambda route)

## Loop over all grid cells
for(g in 1:G){
  log(nu[g]) = alpha_g + area.g[g]*beta_g
} # end g (nu)

####################################################
####################################################
# Priors
####################################################
beta_g    ~ dnorm(0,1)
alpha_g   ~ dnorm(0,1)
####################################################
####################################################
# Derived
####################################################
for(t in 1:T.b){
  N.b[t] <- sum(C.b[,t])
}
####################################################
####################################################
}"
}

mod.name <- paste0(dir.models,"/bbs-pois-null") ## not sure why but when i knit the chunks outside this one it doesn't keep the params, so having trouble putting it up there.
mod.fn <- paste0(mod.name, ".txt") # we want to name it now so we can call in jags functions
sink(mod.fn)
cat(mod())
sink()
# browseURL(mod.fn)
```

# Step 3: Inits and MCMC Specifications
## Inits + MCMC
```{r mcmc-specs, eval=eval.mods}
mcmc <- set_mcmc_specs()
```

```{r jags-inits, eval=eval.mods}
params.monitor <- c("lambda", "nu",  "N.b", "p.b")
myinits <- list(alpha_p.b  = rnorm(1,0,1), 
               alpha_g = rnorm(1, 0, 1), 
               beta_g = rnorm(1, 0, 1),
               beta_p.b = rnorm(1,0,1)
               )
inits <- make_inits_list(myinits, mcmc$nc)
```


# Step 4: Run Model
```{r}
## specify file name
fn.out <- paste0(dir.models, "/", mod.name, ".rds")
out <- jagsUI::jags(
  data  = jags.data,
  model.file = mod.fn,
  inits = inits,
  parameters.to.save = params.monitor,
  n.chains = length(inits),
  n.thin = mcmc$nt,
  n.iter = mcmc$ni,
  n.burnin = mcmc$nb
)
  x = tictoc::toc()
  mod.time <- paste0(round(x$toc - x$tic, 2), " seconds")
  out$tictoc.allchains <- mod.time
  # save model outputs
  saveRDS(out, file = fn.out)
```


# Step 7: Build Model(s)

# TRASH

```{r bbs-pois-with-p-covs}
mod <- "model{
####################################################
####################################################
# Likelihoods
####################################################
for(t in 1:nyears.b){
  for(s in 1:nsites.b){
    C.b[s,t] ~ dpois(lambda[s]*p.b[s,t])
  } # end data model s
} # end data model t

  
for(t in 1:nYearsB){
  for(s in 1:nsites.b){
    logit(p.b[s,t]) <- alpha_p.b + 
                        beta_pf * pf[s,t] + 
                        beta_pw * pw[s,t]
  } # end data model s
} # end data model t


for(s in 1:nsites.b){
  lambda[s]  = inprod(nu[], prop[s,])
} # end s (lambda route)


for(g in 1:nGridsB){
  log(nu[g]) = beta_g*area[g] + alpha_g 
} # end g (nu)

####################################################
####################################################
# Priors
####################################################
## Priors on BBS site(route)-level detection 
alpha_p.b   ~ dnorm(0,0.1) # intercept on the BBS detection model
beta_pf   ~ dnorm(0,1) # observer's first year (on BBS or Route)
beta_pw   ~ dnorm(0,1) # wind
## Priors on BBS grid-level covariates
alpha_g    ~ dnorm(0,1) # intercept on the grid covariates model
beta_g    ~ dnorm(0,1) # grid-cell area (scaled)

####################################################
####################################################
# Derived
####################################################
for(t in 1:nYearsB){
  N.b[t] <- sum(C.b[,t])
}
####################################################
####################################################
}"
## export model
# browseURL(mod.fn)
mod.name <- paste0(dirs$dir.models,"/bbs-pois-with-p-covs") ## not sure why but when i knit the chunks outside this one it doesn't keep the params, so having trouble putting it up there.
mod.fn <- paste0(mod.name, ".txt") # we want to name it now so we can call in jags functions
sink(mod.fn)
cat(mod)
sink()
```
## BBS + eBird
```{r bbs-ebird-w-p-covs}
mod <- "model{
####################################################
### Attempt to incorporate Ce (ebird count processes) in 
####################################################
# Likelihoods
####################################################
for(t in 1:nyears.b){
  for(s in 1:nsites.b){
    C.b[s,t] ~ dpois(lambda[s]*p.b[s,t])
  } # end data model s
} # end data model t

  
for(t in 1:nyears.b){
  for(s in 1:nsites.b){
    logit(p.b[s,t]) <- alpha_p.b + 
                        beta_pf * pf[s,t] + 
                        beta_pw * pw[s,t]
  } # end data model s
} # end data model t


for(s in 1:nSitesB){
  lambda[s]  = inprod(nu[], prop[s,])
} # end s (lambda route)


for(g in 1:nGridsB){
  log(nu[g]) = beta_g*area[g] + alpha_g 
} # end g (nu)

####################################################
####################################################
# Priors
####################################################
## Priors on BBS site(route)-level detection 
alpha_p.b   ~ dnorm(0,0.1) # intercept on the BBS detection model
beta_pf   ~ dnorm(0,1) # observer's first year (on BBS or Route)
beta_pw   ~ dnorm(0,1) # wind
## Priors on BBS grid-level covariates
alpha_g    ~ dnorm(0,1) # intercept on the grid covariates model
beta_g    ~ dnorm(0,1) # grid-cell area (scaled)

####################################################
####################################################
# Derived
####################################################
for(t in 1:nyears.b){
  N.b[t] <- sum(C.b[,t])
}
####################################################
####################################################
}"
## export model
# browseURL(mod.fn)
mod.name <- paste0(dirs$dir.models,"/bbs-ebird-pois-with-p-covs") ## not sure why but when i knit the chunks outside this one it doesn't keep the params, so having trouble putting it up there.
mod.fn <- paste0(mod.name, ".txt") # we want to name it now so we can call in jags functions
sink(mod.fn)
cat(mod)
sink()
```


